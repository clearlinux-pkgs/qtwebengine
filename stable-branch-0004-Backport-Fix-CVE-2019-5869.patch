From 70036bae331d01af54cf2f80756675b93e8608e0 Mon Sep 17 00:00:00 2001
From: Allan Sandfeld Jensen <allan.jensen@qt.io>
Date: Thu, 5 Sep 2019 11:13:15 +0200
Subject: [PATCH] [Backport] Fix CVE-2019-5869
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Always unregister placeholder image in canvas

It's possible that it has been disposed but its ID still exists. This
can lead to UAP bugs.

(cherry picked from commit 2df8ea19c5bba87209e452cea8473c05ea7d5250)

Bug: 978793
Change-Id: Idb4639cb78110878a28ab3c50807174343a66033
Reviewed-by: Fernando Serboncini <fserb@chromium.org>
Reviewed-by: Aaron Krajeski <aaronhk@chromium.org>
Commit-Queue: Fernando Serboncini <fserb@chromium.org>
Commit-Queue: Aaron Krajeski <aaronhk@chromium.org>
Cr-Original-Commit-Position: refs/heads/master@{#685345}
Cr-Commit-Position: refs/branch-heads/3809@{#1013}
Cr-Branched-From: d82dec1a818f378c464ba307ddd9c92133eac355-refs/heads/master@{#665002}
Reviewed-by: Michael Br√ºning <michael.bruning@qt.io>
---
 .../blink/renderer/core/html/canvas/html_canvas_element.cc    | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/src/3rdparty/chromium/third_party/blink/renderer/core/html/canvas/html_canvas_element.cc b/src/3rdparty/chromium/third_party/blink/renderer/core/html/canvas/html_canvas_element.cc
index 66fdad90e34..ae42e4d0243 100644
--- a/src/3rdparty/chromium/third_party/blink/renderer/core/html/canvas/html_canvas_element.cc
+++ b/src/3rdparty/chromium/third_party/blink/renderer/core/html/canvas/html_canvas_element.cc
@@ -154,8 +154,10 @@ HTMLCanvasElement::~HTMLCanvasElement() {
 void HTMLCanvasElement::Dispose() {
   if (PlaceholderFrame()) {
     ReleasePlaceholderFrame();
-    UnregisterPlaceholder();
   }
+  // It's possible that the placeholder frame has been disposed but its ID still
+  // exists. Make sure that it gets unregistered here
+  UnregisterPlaceholder();
 
   // We need to drop frame dispatcher, to prevent mojo calls from completing.
   frame_dispatcher_ = nullptr;
-- 
2.24.0

