From 24a674a2ce8b1e2bce35bad7f8aa3e4706dda88f Mon Sep 17 00:00:00 2001
From: Allan Sandfeld Jensen <allan.jensen@qt.io>
Date: Thu, 17 Oct 2019 11:09:33 +0200
Subject: [PATCH] [Backport] CVE-2019-13674
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Added Georgian d to confusables mapping

Added Georgian d to mapping of frequently confused symbol
based on idn spoofing possibility of d4000.com

Bug: 896533
Change-Id: I2c308379ffa9d4b67923dee3d40700c0c733a696
Reviewed-by: Tommy Li <tommycli@chromium.org>
Reviewed-by: Mustafa Emre Acer <meacer@chromium.org>
Commit-Queue: Cynthia Liang <liangcyn@google.com>
Cr-Commit-Position: refs/heads/master@{#677585}
Reviewed-by: Michael Brüning <michael.bruning@qt.io>
---
 .../components/url_formatter/idn_spoof_checker.cc    |  9 ++++-----
 .../url_formatter/top_domains/test_domains.list      |  1 +
 .../url_formatter/top_domains/test_domains.skeletons |  1 +
 .../url_formatter/url_formatter_unittest.cc          | 12 ++++++++++++
 4 files changed, 18 insertions(+), 5 deletions(-)

diff --git a/src/3rdparty/chromium/components/url_formatter/idn_spoof_checker.cc b/src/3rdparty/chromium/components/url_formatter/idn_spoof_checker.cc
index 12a5fd92ab9..6c690286e06 100644
--- a/src/3rdparty/chromium/components/url_formatter/idn_spoof_checker.cc
+++ b/src/3rdparty/chromium/components/url_formatter/idn_spoof_checker.cc
@@ -226,8 +226,8 @@ IDNSpoofChecker::IDNSpoofChecker() {
   //   - {U+0493 (ғ), U+04FB (ӻ)} => f
   //   - {U+04AB (ҫ), U+1004 (င)} => c
   //   - U+04B1 (ұ) => y
-  //   - U+03C7 (χ), U+04B3 (ҳ), U+04FD (ӽ), U+04FF (ӿ) => x
-  //   - U+0503 (ԃ) => d
+  //   - {U+03C7 (χ), U+04B3 (ҳ), U+04FD (ӽ), U+04FF (ӿ)} => x
+  //   - {U+0503 (ԃ), U+10EB (ძ)} => d
   //   - {U+050D (ԍ), U+100c (ဌ)} => g
   //   - {U+0D1F (ട), U+0E23 (ร), U+0EA3 (ຣ), U+0EAE (ຮ)} => s
   //   - U+1042 (၂) => j
@@ -251,7 +251,7 @@ IDNSpoofChecker::IDNSpoofChecker() {
           "[ŧтҭԏ] > t; [ƅьҍв] > b;  [ωшщพฟພຟ] > w;"
           "[мӎ] > m; [єҽҿၔ] > e; ґ > r; [ғӻ] > f;"
           "[ҫင] > c; ұ > y; [χҳӽӿ] > x;"
-          "ԃ  > d; [ԍဌ] > g; [ടรຣຮ] > s; ၂ > j;"
+          "[ԃძ]  > d; [ԍဌ] > g; [ടรຣຮ] > s; ၂ > j;"
           "[०০੦૦ଠ୦೦] > o;"
           "[৭੧૧] > q;"
           "[บບ] > u;"
@@ -259,8 +259,7 @@ IDNSpoofChecker::IDNSpoofChecker() {
           "[зҙӡउওਤ੩૩౩ဒვპ] > 3;"
           "[੫] > 4;"
           "[৪੪୫] > 8;"
-          "[૭୨౨] > 9;"
-      ),
+          "[૭୨౨] > 9;"),
       UTRANS_FORWARD, parse_error, status));
   DCHECK(U_SUCCESS(status))
       << "Spoofchecker initalization failed due to an error: "
diff --git a/src/3rdparty/chromium/components/url_formatter/top_domains/test_domains.list b/src/3rdparty/chromium/components/url_formatter/top_domains/test_domains.list
index 466dadebff5..bef6a42a8f9 100644
--- a/src/3rdparty/chromium/components/url_formatter/top_domains/test_domains.list
+++ b/src/3rdparty/chromium/components/url_formatter/top_domains/test_domains.list
@@ -1,3 +1,4 @@
+d4000.com
 digklmo68.com
 digklmo68.co.uk
 islkpx123.com
diff --git a/src/3rdparty/chromium/components/url_formatter/top_domains/test_domains.skeletons b/src/3rdparty/chromium/components/url_formatter/top_domains/test_domains.skeletons
index ecf5b68a795..b5634757fb7 100644
--- a/src/3rdparty/chromium/components/url_formatter/top_domains/test_domains.skeletons
+++ b/src/3rdparty/chromium/components/url_formatter/top_domains/test_domains.skeletons
@@ -9,6 +9,7 @@
 # Each entry is the skeleton of a top domain for the confusability check
 # in components/url_formatter/url_formatter.cc.
 
+d4OOO.corn, d4000.com
 digklrno68.corn, digklmo68.com
 digklrno68.co.uk, digklmo68.co.uk
 islkpxl23.corn, islkpx123.com
diff --git a/src/3rdparty/chromium/components/url_formatter/url_formatter_unittest.cc b/src/3rdparty/chromium/components/url_formatter/url_formatter_unittest.cc
index 3a197c0b2b4..6882cd4119b 100644
--- a/src/3rdparty/chromium/components/url_formatter/url_formatter_unittest.cc
+++ b/src/3rdparty/chromium/components/url_formatter/url_formatter_unittest.cc
@@ -134,6 +134,13 @@ const IDNTestCase idn_cases[] = {
     {"xn---123-kbjl2j0bl2k.in", L"\x0939\x093f\x0928\x094d\x0926\x0940-123.in",
      true},
 
+    // URL test with mostly numbers and one confusable character
+    // Georgian 'd' 4000.com
+    {"xn--4000-pfr.com",
+     L"\x10eb"
+     L"4000.com",
+     false},
+
     // What used to be 5 Aspirational scripts in the earlier versions of UAX 31.
     // UAX 31 does not define aspirational scripts any more.
     // See http://www.unicode.org/reports/tr31/#Aspirational_Use_Scripts .
@@ -169,6 +176,11 @@ const IDNTestCase idn_cases[] = {
     {"xn--hllo-bpa7979ih5m.cn", L"h\x00e9llo\x4e2d\x56fd.cn", false},
     // <Greek rho><Cyrillic a><Cyrillic u>.ru
     {"xn--2xa6t2b.ru", L"\x03c1\x0430\x0443.ru", false},
+    // Georgian + Latin
+    {"xn--abcef-vuu.test",
+     L"abc\x10eb"
+     L"ef.test",
+     false},
     // Hangul + Latin
     {"xn--han-eb9ll88m.kr", L"\xd55c\xae00han.kr", true},
     // Hangul + Latin + Han with IDN ccTLD
-- 
2.23.0

