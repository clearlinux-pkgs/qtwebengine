From a0d7bfaee7db87dc241a1940a3a6a97fd09c6293 Mon Sep 17 00:00:00 2001
From: Allan Sandfeld Jensen <allan.jensen@qt.io>
Date: Mon, 14 Oct 2019 14:22:07 +0200
Subject: [PATCH] [Backport] CVE-2019-13659
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Disallow combining Kana voiced sound marks (U+3099 and U+309A) in IDN

This CL disallows U+3099 and U+309A characters from domain names. Any IDN
containing these characters will be displayed as punycode.

As of July 2019, these characters are not used in any popular domains.

Bug: 868846
Change-Id: I7e36b30d7dcaf167fb3a6eb23b96f0aa4bd393ee
Reviewed-by: Christopher Thompson <cthomp@chromium.org>
Commit-Queue: Mustafa Emre Acer <meacer@chromium.org>
Cr-Commit-Position: refs/heads/master@{#681043}
Reviewed-by: JÃ¼ri Valdmann <juri.valdmann@qt.io>
---
 chromium/components/url_formatter/idn_spoof_checker.cc | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/src/3rdparty/chromium/components/url_formatter/idn_spoof_checker.cc b/src/3rdparty/chromium/components/url_formatter/idn_spoof_checker.cc
index 2b9c17faafa..12a5fd92ab9 100644
--- a/src/3rdparty/chromium/components/url_formatter/idn_spoof_checker.cc
+++ b/src/3rdparty/chromium/components/url_formatter/idn_spoof_checker.cc
@@ -354,6 +354,7 @@ bool IDNSpoofChecker::SafeToDisplayAsUnicode(base::StringPiece16 label,
     //   character. Other combining diacritical marks are not in the allowed
     //   character set.
     // - Disallow dotless i (U+0131) followed by a combining mark.
+    // - Disallow combining Kana voiced sound marks.
     // - Disallow U+0307 (dot above) after 'i', 'j', 'l' or dotless i (U+0131).
     //   Dotless j (U+0237) is not in the allowed set to begin with.
     dangerous_pattern = new icu::RegexMatcher(
@@ -368,6 +369,7 @@ bool IDNSpoofChecker::SafeToDisplayAsUnicode(base::StringPiece16 label,
             R"([a-z]\u30fb|\u30fb[a-z]|)"
             R"([^\p{scx=latn}\p{scx=grek}\p{scx=cyrl}][\u0300-\u0339]|)"
             R"(\u0131[\u0300-\u0339]|)"
+            R"(\u3099|\u309A|)"
             R"([ijl]\u0307)",
             -1, US_INV),
         0, status);
-- 
2.23.0

