From 635b163527bd894b128b2806805f270f8d5f808e Mon Sep 17 00:00:00 2001
From: Allan Sandfeld Jensen <allan.jensen@qt.io>
Date: Mon, 14 Oct 2019 13:44:35 +0200
Subject: [PATCH] [Backport] CVE-2019-13697

[M77] [resource-timing] Report performance entries with failing status codes

Currently we don't report performance entries with failing status codes.
From the spec's perspective, reporting aborts is a MAY, but failing
status code responses should not be considered aborts. [1]
Chromium is the only engine which doesn't report those entries.
This CL fixes that to report them similarly to successful status codes.

Bug: 883400, 990849
Change-Id: Ic5e99e3df77f3869aa0dd70f0141d88016fdb972

[1] https://github.com/w3c/resource-timing/issues/165#issuecomment-441413636

(cherry picked from commit 5e556dd80e03b7a217e10990d71be25d07e1ece7)

Change-Id: Ic5e99e3df77f3869aa0dd70f0141d88016fdb972
Commit-Queue: Yoav Weiss <yoavweiss@chromium.org>
Reviewed-by: Yutaka Hirano <yhirano@chromium.org>
Reviewed-by: Mike West <mkwst@chromium.org>
Cr-Original-Commit-Position: refs/heads/master@{#695596}
Reviewed-by: Dale Curtis <dalecurtis@chromium.org>
Cr-Commit-Position: refs/branch-heads/3865@{#857}
Cr-Branched-From: 0cdcc6158160790658d1f033d3db873603250124-refs/heads/master@{#681094}
Reviewed-by: Michal Klocek <michal.klocek@qt.io>
---
 .../blink/renderer/platform/loader/fetch/resource_fetcher.cc   | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/src/3rdparty/chromium/third_party/blink/renderer/platform/loader/fetch/resource_fetcher.cc b/src/3rdparty/chromium/third_party/blink/renderer/platform/loader/fetch/resource_fetcher.cc
index dd3ff0fd819..186a54eb4c6 100644
--- a/src/3rdparty/chromium/third_party/blink/renderer/platform/loader/fetch/resource_fetcher.cc
+++ b/src/3rdparty/chromium/third_party/blink/renderer/platform/loader/fetch/resource_fetcher.cc
@@ -1519,8 +1519,7 @@ void ResourceFetcher::HandleLoaderFinish(Resource* resource,
     // Store redirect responses that were packed inside the final response.
     AddRedirectsToTimingInfo(resource, info.get());
 
-    if (resource->GetResponse().IsHTTP() &&
-        resource->GetResponse().HttpStatusCode() < 400) {
+    if (resource->GetResponse().IsHTTP()) {
       PopulateTimingInfo(info.get(), resource);
       info->SetLoadFinishTime(finish_time);
       // encodedDataLength == -1 means "not available".
-- 
2.23.0

