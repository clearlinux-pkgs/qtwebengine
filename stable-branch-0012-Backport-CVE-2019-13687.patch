From 5f1b74a907d40e92a6395833d9c4cc7f9d0d14f7 Mon Sep 17 00:00:00 2001
From: Allan Sandfeld Jensen <allan.jensen@qt.io>
Date: Mon, 14 Oct 2019 13:23:51 +0200
Subject: [PATCH] [Backport] CVE-2019-13687
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

[Video Capture Manager] Convert pointers from Unretained to WeakPtr.

This CL replaces the usage of unretained pointers with weak pointers
in VideoCaptureManager.

This conversion is safe because all places where the pointers are saved
are on the IO thread as well as the place were the callbacks are then
executed (see line 326 and 348).

BUG=998548

(cherry picked from commit b740a6052b00ebeec4bdc3044a130aab0c64ab05)

Change-Id: I47bda798fa7bcbd66bf23682ee6c6dd26b5642c1
Reviewed-by: Guido Urdaneta <guidou@chromium.org>
Commit-Queue: Armando Miraglia <armax@chromium.org>
Cr-Original-Commit-Position: refs/heads/master@{#694214}
Reviewed-by: Armando Miraglia <armax@chromium.org>
Cr-Commit-Position: refs/branch-heads/3865@{#801}
Cr-Branched-From: 0cdcc6158160790658d1f033d3db873603250124-refs/heads/master@{#681094}
Reviewed-by: JÃ¼ri Valdmann <juri.valdmann@qt.io>
---
 .../browser/renderer_host/media/video_capture_manager.cc | 9 ++++-----
 1 file changed, 4 insertions(+), 5 deletions(-)

diff --git a/src/3rdparty/chromium/content/browser/renderer_host/media/video_capture_manager.cc b/src/3rdparty/chromium/content/browser/renderer_host/media/video_capture_manager.cc
index 735446ae3f4..f7ebd9b9c19 100644
--- a/src/3rdparty/chromium/content/browser/renderer_host/media/video_capture_manager.cc
+++ b/src/3rdparty/chromium/content/browser/renderer_host/media/video_capture_manager.cc
@@ -595,8 +595,7 @@ void VideoCaptureManager::GetPhotoState(
     media::VideoCaptureDevice::GetPhotoStateCallback callback) {
   DCHECK_CURRENTLY_ON(BrowserThread::IO);
 
-  const VideoCaptureController* controller =
-      LookupControllerBySessionId(session_id);
+  VideoCaptureController* controller = LookupControllerBySessionId(session_id);
   if (!controller)
     return;
   if (controller->IsDeviceAlive()) {
@@ -607,7 +606,7 @@ void VideoCaptureManager::GetPhotoState(
   photo_request_queue_.emplace_back(
       session_id,
       base::Bind(&VideoCaptureController::GetPhotoState,
-                 base::Unretained(controller), base::Passed(&callback)));
+                 controller->GetWeakPtrForIOThread(), base::Passed(&callback)));
 }
 
 void VideoCaptureManager::SetPhotoOptions(
@@ -626,7 +625,7 @@ void VideoCaptureManager::SetPhotoOptions(
   // Queue up a request for later.
   photo_request_queue_.emplace_back(
       session_id, base::Bind(&VideoCaptureController::SetPhotoOptions,
-                             base::Unretained(controller),
+                             controller->GetWeakPtrForIOThread(),
                              base::Passed(&settings), base::Passed(&callback)));
 }
 
@@ -646,7 +645,7 @@ void VideoCaptureManager::TakePhoto(
   photo_request_queue_.emplace_back(
       session_id,
       base::Bind(&VideoCaptureController::TakePhoto,
-                 base::Unretained(controller), base::Passed(&callback)));
+                 controller->GetWeakPtrForIOThread(), base::Passed(&callback)));
 }
 
 void VideoCaptureManager::OnOpened(
-- 
2.23.0

