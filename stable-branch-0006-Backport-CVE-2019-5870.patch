From 55e2f9a305cce473fd98a912beff67cdbccc6e47 Mon Sep 17 00:00:00 2001
From: Allan Sandfeld Jensen <allan.jensen@qt.io>
Date: Mon, 14 Oct 2019 11:01:40 +0200
Subject: [PATCH] [Backport] CVE-2019-5870

Merge "Add more checks in MojoCdmService"

This is to prevent abnormal cases from happening.

(cherry picked from commit b7b305f3389017cc42e2cfac6e7a319f42d5bde3)

Bug: 999311
Test: Tested w/ shaka player demo and existing unit tests pass
Change-Id: Icef06d979351f16386cf3cbb177971a57a1e264c
Auto-Submit: Xiaohan Wang <xhwang@chromium.org>
Reviewed-by: Daniel Cheng <dcheng@chromium.org>
Reviewed-by: John Rummell <jrummell@chromium.org>
Commit-Queue: Daniel Cheng <dcheng@chromium.org>
Commit-Queue: Xiaohan Wang <xhwang@chromium.org>
Cr-Original-Commit-Position: refs/heads/master@{#691911}
Cr-Commit-Position: refs/branch-heads/3865@{#688}
Cr-Branched-From: 0cdcc6158160790658d1f033d3db873603250124-refs/heads/master@{#681094}
Reviewed-by: Michal Klocek <michal.klocek@qt.io>
---
 chromium/media/mojo/services/mojo_cdm_service.cc | 5 ++++-
 chromium/media/mojo/services/mojo_cdm_service.h  | 2 ++
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/src/3rdparty/chromium/media/mojo/services/mojo_cdm_service.cc b/src/3rdparty/chromium/media/mojo/services/mojo_cdm_service.cc
index 31bb3e7fa5e..11c1f3c0e1a 100644
--- a/src/3rdparty/chromium/media/mojo/services/mojo_cdm_service.cc
+++ b/src/3rdparty/chromium/media/mojo/services/mojo_cdm_service.cc
@@ -62,7 +62,9 @@ void MojoCdmService::Initialize(const std::string& key_system,
                                 const CdmConfig& cdm_config,
                                 InitializeCallback callback) {
   DVLOG(1) << __func__ << ": " << key_system;
-  DCHECK(!cdm_);
+
+  CHECK(!has_initialize_been_called_) << "Initialize should only happen once";
+  has_initialize_been_called_ = true;
 
   auto weak_this = weak_factory_.GetWeakPtr();
   cdm_factory_->Create(
@@ -156,6 +158,7 @@ void MojoCdmService::OnCdmCreated(
     return;
   }
 
+  CHECK(!cdm_) << "CDM should only be created once.";
   cdm_ = cdm;
 
   if (context_) {
diff --git a/src/3rdparty/chromium/media/mojo/services/mojo_cdm_service.h b/src/3rdparty/chromium/media/mojo/services/mojo_cdm_service.h
index 716620b9e6c..fc885bd3f98 100644
--- a/src/3rdparty/chromium/media/mojo/services/mojo_cdm_service.h
+++ b/src/3rdparty/chromium/media/mojo/services/mojo_cdm_service.h
@@ -100,6 +100,8 @@ class MEDIA_MOJO_EXPORT MojoCdmService : public mojom::ContentDecryptionModule {
   // Callback for when |decryptor_| loses connectivity.
   void OnDecryptorConnectionError();
 
+  bool has_initialize_been_called_ = false;
+
   CdmFactory* cdm_factory_;
   MojoCdmServiceContext* const context_ = nullptr;
   scoped_refptr<::media::ContentDecryptionModule> cdm_;
-- 
2.23.0

